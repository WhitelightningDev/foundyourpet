/* eslint-disable no-console */
const fs = require("fs");
const path = require("path");

const firebaseConfig = {
  apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
  storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.REACT_APP_FIREBASE_APP_ID,
};

const outputPath = path.join(__dirname, "..", "public", "push-sw.js");
const hasConfig = Object.values(firebaseConfig).every(Boolean);

const header =
  "/*\n" +
  " * AUTO-GENERATED FILE\n" +
  " * Generated by scripts/generate-firebase-messaging-sw.cjs\n" +
  " *\n" +
  " * This file enables Firebase Cloud Messaging background notifications.\n" +
  " */\n";

if (!hasConfig) {
  const stub =
    header +
    "\n" +
    "self.addEventListener('install', () => self.skipWaiting());\n" +
    "self.addEventListener('activate', (event) => event.waitUntil(self.clients.claim()));\n" +
    "\n" +
    "self.addEventListener('push', (event) => {\n" +
    "  try {\n" +
    "    const data = event.data?.json?.() || null;\n" +
    "    const title = data?.title || data?.notification?.title || 'Found Your Pet';\n" +
    "    const body = data?.body || data?.notification?.body || '';\n" +
    "    const url = data?.url || data?.data?.url || '/';\n" +
    "    event.waitUntil(self.registration.showNotification(title, { body, icon: '/android-chrome-192x192.png', data: { url } }));\n" +
    "  } catch {\n" +
    "    // ignore\n" +
    "  }\n" +
    "});\n" +
    "\n" +
    "self.addEventListener('notificationclick', (event) => {\n" +
    "  event.notification?.close?.();\n" +
    "  const url = event.notification?.data?.url || '/';\n" +
    "  event.waitUntil(self.clients.openWindow(url));\n" +
    "});\n";
  fs.writeFileSync(outputPath, stub, "utf8");
  console.log("[fcm] Wrote stub push-sw.js (missing Firebase env vars).");
  process.exit(0);
}

const sw =
  header +
  "\n" +
  "importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js');\n" +
  "importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js');\n" +
  "\n" +
  `firebase.initializeApp(${JSON.stringify(firebaseConfig, null, 2)});\n` +
  "const messaging = firebase.messaging();\n" +
  "\n" +
  "messaging.onBackgroundMessage((payload) => {\n" +
  "  const title = payload?.notification?.title || 'Found Your Pet';\n" +
  "  const options = {\n" +
  "    body: payload?.notification?.body,\n" +
  "    icon: '/android-chrome-192x192.png',\n" +
  "    data: payload?.data || {},\n" +
  "  };\n" +
  "  self.registration.showNotification(title, options);\n" +
  "});\n" +
  "\n" +
  "// Also support generic Web Push payloads.\n" +
  "self.addEventListener('push', (event) => {\n" +
  "  try {\n" +
  "    const data = event.data?.json?.() || null;\n" +
  "    const title = data?.title || data?.notification?.title;\n" +
  "    if (!title) return;\n" +
  "    const body = data?.body || data?.notification?.body || '';\n" +
  "    const url = data?.url || data?.data?.url || '/';\n" +
  "    event.waitUntil(self.registration.showNotification(title, { body, icon: '/android-chrome-192x192.png', data: { url } }));\n" +
  "  } catch {\n" +
  "    // ignore\n" +
  "  }\n" +
  "});\n" +
  "\n" +
  "self.addEventListener('notificationclick', (event) => {\n" +
  "  event.notification?.close?.();\n" +
  "  const url = event.notification?.data?.url || '/';\n" +
  "  event.waitUntil(self.clients.openWindow(url));\n" +
  "});\n";

fs.writeFileSync(outputPath, sw, "utf8");
console.log("[fcm] Wrote push-sw.js");
